class AcGameIntroduce{constructor(t){this.root=t,this.$introduce=$('\n<div class="ac-game-introduce">\n    <div class="ac-game-introduce-container">\n        <div class="ac-game-introduce-container-title">Q版球球大作战</div>\n            <div class="ac-game-introduce-container-rules">\n                <h2>游戏玩法</h2>\n                    <ul>\n                        <li>玩家通过键盘选择技能,然后通过鼠标进行技能释放、移动角色;</li>\n                        <li>q 键选择火球技能,被击中玩家有3%加速效果，cd：3s;</li>\n                        <li>w 键选择冰球技能,被击中玩家有15%减速效果，cd：3s;</li>\n                        <li>f 键选择闪现技能,可以全局瞬移，cd：5s;</li>\n                        <li>enter开启问候模式,再次enter即可发送消息，esc退出;</li>\n                    </ul>\n        </div>\n        <div class="ac-game-introduce-container-mode">\n            <h2>游戏模式</h2>\n                <ul>\n                    <li>单人模式：8名人机，会随机移动 + 释放技能，你需要把它们全部击杀才能获得游戏的胜利！！！</li>\n                    <li>多人模式：3人一个房间，满3人开始游戏，快和你的小伙伴们一起同台竞技吧！！！</li>\n                </ul>\n        </div>\n        <div class="ac-game-introduce-container-return-btn">返回游戏</div>\n    </div>\n</div>\n'),this.$introduce.hide(),this.root.$ac_game.append(this.$introduce),this.$return_btn=this.$introduce.find(".ac-game-introduce-container-return-btn"),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$return_btn.click((function(){t.hide(),t.root.menu.show()}))}show(){this.$introduce.show()}hide(){this.$introduce.hide()}}class AcGameMenu{constructor(t){this.root=t,this.$menu=$('\n<div class="ac-game-menu">\n    <audio class="ac-game-menu-bgm" src="https://www.renyuhui.top/static/audio/menu/begin.mp3" preload="auto" autoplay="autoplay" loop="loop"></audio>\n    <div class="ac-game-menu-field">\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-single-mode">\n            单人模式\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-multi-mode">\n            多人模式\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-introduce">\n            游戏说明\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-settings">\n            注销账号\n        </div>\n    </div>\n</div>\n'),this.$menu.hide(),this.root.$ac_game.append(this.$menu),this.$single_mode=this.$menu.find(".ac-game-menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".ac-game-menu-field-item-multi-mode"),this.$introduce=this.$menu.find(".ac-game-menu-field-item-introduce"),this.$settings=this.$menu.find(".ac-game-menu-field-item-settings"),this.start(),this.$menu_bgm=document.getElementsByClassName("ac-game-menu-bgm")[0],this.$menu_bgm.volume=.3}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$single_mode.click((function(){t.hide(),t.root.playground.show("single mode")})),this.$multi_mode.click((function(){t.hide(),t.root.playground.show("multi mode")})),this.$introduce.click((function(){t.hide(),t.root.introduce.show()})),this.$settings.click((function(){t.root.settings.logout_on_remote()}))}show(){this.$menu.show()}hide(){this.$menu.hide()}}let last_timestamp,AC_GAME_OBJECTS=[];class AcGameObject{constructor(){AC_GAME_OBJECTS.push(this),this.has_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}start(){}update(){}create_uuid(){let t="";for(let i=0;i<18;i++){t+=parseInt(Math.floor(10*Math.random()))}return t}on_destroy(){}destroy(){this.on_destroy();for(let t=0;t<AC_GAME_OBJECTS.length;t++)if(AC_GAME_OBJECTS[t]===this){AC_GAME_OBJECTS.splice(t,1);break}}}let AC_GAME_ANIMATION=function(t){for(let i=0;i<AC_GAME_OBJECTS.length;i++){let s=AC_GAME_OBJECTS[i];s.has_called_start?(s.timedelta=t-last_timestamp,s.update()):(s.start(),s.has_called_start=!0)}last_timestamp=t,requestAnimationFrame(AC_GAME_ANIMATION)};requestAnimationFrame(AC_GAME_ANIMATION);class ChatField{constructor(t){this.playground=t,this.$history=$("<div class=ac-game-chat-field-history>历史记录</div>"),this.$input=$('<input type="text" placeholder="问候别人,enter发送消息 (•̀ᴗ• )" class=ac-game-chat-field-input>'),this.$history.hide(),this.$input.hide(),this.func_id=null,this.playground.$playground.append(this.$history),this.playground.$playground.append(this.$input),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$input.keydown((function(i){if(27===i.which)return t.hide_input(),!1;if(13===i.which){let i=t.playground.root.settings.username,s=t.$input.val();s&&(t.$input.val(""),t.add_message(i,s),t.playground.mps.send_message(i,s))}}))}show_input(){this.$input.show(),this.$input.focus()}render_message(t){return $(`<div>${t}</div>`)}add_message(t,i){this.show_history();let s=`[${t}]${i}`;this.$history.append(this.render_message(s)),this.$history.scrollTop(this.$history[0].scrollHeight)}hide_input(){this.$input.hide(),this.playground.game_map.$canvas.focus()}show_history(){let t=this;this.$history.fadeIn(),this.func_id&&clearTimeout(this.func_id),this.func_id=setTimeout((function(){t.$history.fadeOut(),t.func_id=null}),3e3)}}class GameMap extends AcGameObject{constructor(t){super(),this.playground=t,this.$canvas=$("<canvas tabindex=0></canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.playground.$playground.append(this.$canvas)}start(){this.$canvas.focus()}resize(){this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}update(){this.render()}render(){this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class GameOver extends AcGameObject{constructor(t,i){super(),this.playground=t,this.mode=i,this.state=null,this.$game_over=$('\n            <div class="game-over-layer">\n                <div class="game-over-container">\n                    <div class="game-over-title">游戏结束</div>\n                    <div class="game-over-message"></div>\n                    <div class="game-over-buttons">\n                        <button class="restart-button">重新开始</button>\n                        <button class="menu-button">返回菜单</button>\n                    </div>\n                </div>\n            </div>\n        '),this.$game_over.hide(),this.playground.$playground.append(this.$game_over),this.game_over_message=this.$game_over.find(".game-over-message"),this.$restart=this.$game_over.find(".restart-button"),this.$return_menu=this.$game_over.find(".menu-button"),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$restart.click((function(){t.hide(),t.playground.hide(),t.playground.show(t.mode)})),this.$return_menu.click((function(){t.hide(),t.playground.hide(),t.playground.root.menu.show()}))}win(){this.state="win",this.game_over_message.html("赢了，你真帅！！！"),this.show()}lose(){this.state="lose",this.game_over_message.html("输了，你真菜！！！"),this.show()}show(){this.$game_over.show()}hide(){this.$game_over.hide()}}class NoticeBoard extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.text="已就绪：0人"}start(){}write(t){this.text=t}update(){this.render()}render(){this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.playground.width/2,20)}}class Particle extends AcGameObject{constructor(t,i,s,e,a,h,n,l,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s,this.radius=e,this.vx=a,this.vy=h,this.color=n,this.speed=l,this.move_length=r,this.eps=.01,this.friction=.9}start(){}update(){if(this.move_length<this.eps||this.speed<this.eps)return this.destroy(),!1;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.speed*=this.friction,this.move_length-=t,this.render()}render(){let t=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class Player extends AcGameObject{constructor(t,i,s,e,a,h,n,l,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s,this.vx=0,this.vy=0,this.damage_x=0,this.damage_y=0,this.damage_speed=0,this.move_length=0,this.radius=e,this.color=a,this.speed=h,this.role=n,this.username=l,this.photo=r,this.eps=.01,this.friction=.9,this.spent_time=0,this.cnt=0,this.balls=[],this.cur_skill=null,"robot"!==this.role&&(this.img=new Image,this.img.src=this.photo),"me"===this.role&&(this.fireball_coldtime=3,this.fireball_img=new Image,this.fireball_img.src="https://www.renyuhui.top/static/image/playground/fireball.png",this.iceball_coldtime=3,this.iceball_img=new Image,this.iceball_img.src="https://www.renyuhui.top/static/image/playground/iceball.png",this.flash_coldtime=5,this.flash_img=new Image,this.flash_img.src="https://www.renyuhui.top/static/image/playground/flash.png")}start(){if(this.playground.player_count++,this.playground.notice_board.write("已就绪: "+this.playground.player_count+"人"),this.playground.player_count>=3&&(this.playground.state="fighting",this.playground.notice_board.write("Fighting")),"me"===this.role)this.add_listening_events();else if("robot"===this.role){let t=Math.random()*this.playground.width/this.playground.scale,i=Math.random();this.move_to(t,i)}}add_listening_events(){let t=this;this.playground.game_map.$canvas.on("contextmenu",(function(){return!1})),this.playground.game_map.$canvas.mousedown((function(i){if("fighting"!==t.playground.state)return!0;const s=t.ctx.canvas.getBoundingClientRect();if(3===i.which){let e=(i.clientX-s.left)/t.playground.scale,a=(i.clientY-s.top)/t.playground.scale;t.move_to(e,a),"multi mode"===t.playground.mode&&t.playground.mps.send_move_to(e,a)}else if(1===i.which){let e=(i.clientX-s.left)/t.playground.scale,a=(i.clientY-s.top)/t.playground.scale;if("fireball"===t.cur_skill){if(t.fireball_coldtime>t.eps)return!1;let i=t.shoot_ball("fireball",e,a);"multi mode"===t.playground.mode&&t.playground.mps.send_shoot_ball("fireball",e,a,i.uuid)}else if("iceball"===t.cur_skill){if(t.iceball_coldtime>t.eps)return!1;let i=t.shoot_ball("iceball",e,a);"multi mode"===t.playground.mode&&t.playground.mps.send_shoot_ball("iceball",e,a,i.uuid)}else if("flash"===t.cur_skill){if(t.flash_coldtime>t.eps)return!1;t.flash(e,a),"multi mode"===t.playground.mode&&t.playground.mps.send_flash(e,a)}t.cur_skill=null}})),this.playground.game_map.$canvas.keydown((function(i){if(13===i.which){if("multi mode"===t.playground.mode)return t.playground.chat_field.show_input(),!1}else 27===i.which&&"multi mode"===t.playground.mode&&t.playground.chat_field.hide_input();return"fighting"!==t.playground.state||(81===i.which?t.fireball_coldtime>t.eps||(t.cur_skill="fireball",!1):87===i.which?t.iceball_coldtime>t.eps||(t.cur_skill="iceball",!1):70===i.which?t.flash_coldtime>t.eps||(t.cur_skill="flash",!1):void 0)}))}shoot_ball(t,i,s){let e,a=this.x,h=this.y,n=Math.atan2(s-this.y,i-this.x),l=Math.cos(n),r=Math.sin(n);if("fireball"===t){e="orange";let t=new Ball(this.playground,this,a,h,.01,l,r,e,.5,1,.01);return this.fireball_coldtime=3,this.balls.push(t),t}{e="white";let t=new Ball(this.playground,this,a,h,.01,l,r,e,.5,1,.01);return this.iceball_coldtime=3,this.balls.push(t),t}}flash(t,i){let s=this.get_dist(this.x,this.y,t,i);s=Math.max(s,.8);let e=Math.atan2(i-this.y,t-this.x);this.x+=s*Math.cos(e),this.y+=s*Math.sin(e),this.flash_coldtime=5,this.move_length=0}get_dist(t,i,s,e){let a=t-s,h=i-e;return Math.sqrt(a*a+h*h)}move_to(t,i){this.move_length=this.get_dist(this.x,this.y,t,i);let s=Math.atan2(i-this.y,t-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}is_attacked(t,i){new Audio("/static/audio/playground/hitted.mp3").play();for(let t=1;t<20+10*Math.random();t++){let t=this.x,i=this.y,s=this.radius*Math.random()*.16,e=2*Math.PI*Math.random(),a=Math.cos(e),h=Math.sin(e),n=this.color,l=10*this.speed,r=this.radius*Math.random()*5;new Particle(this.playground,t,i,s,a,h,n,l,r)}let s=this.color;if(this.radius-=i,this.radius<this.eps)return this.destroy(),!1;this.damage_x=Math.cos(t),this.damage_y=Math.sin(t),this.damage_speed=100*i;let e=1;e="orange"===s?1.03:.85,this.speed*=e}receive_attack(t,i,s,e,a,h){h.destroy_ball(a),this.x=t,this.y=i,this.is_attacked(s,e)}update(){if(this.cnt+=1,this.cnt%10==0){let t=this.playground.width*Math.random(),i=this.playground.height*Math.random();new Star(this.playground,t,i)}this.spent_time+=this.timedelta/1e3,this.update_win(),"me"===this.role&&"fighting"===this.playground.state&&this.update_coldtime(),this.update_move(),this.render()}update_win(){"fighting"===this.playground.state&&"me"===this.role&&1===this.playground.players.length&&(this.playground.state="over",this.playground.game_over.win())}update_coldtime(){this.fireball_coldtime-=this.timedelta/1e3,this.fireball_coldtime=Math.max(this.fireball_coldtime,0),this.iceball_coldtime-=this.timedelta/1e3,this.iceball_coldtime=Math.max(this.iceball_coldtime,0),this.flash_coldtime-=this.timedelta/1e3,this.flash_coletime=Math.max(this.flash_coldtime,0)}update_move(){if("robot"===this.role&&this.spent_time>4&&Math.random()<1/300){let t,i=this.playground.players[Math.floor(Math.random()*this.playground.players.length)],s=i.x+i.speed*this.vx*this.timedelta/1001*.3,e=i.y+i.speed*this.vy*this.timedelta/1e3*.3;t=Math.random()<.5?"fireball":"iceball",this.shoot_ball(t,s,e)}if(this.damage_speed>this.eps)this.vx=this.vy=0,this.move_length=0,this.x+=this.damage_x*this.damage_speed*this.timedelta/1e3,this.y+=this.damage_y*this.damage_speed*this.timedelta/1e3,this.x<0&&(this.x=0),this.x>this.playground.width/this.playground.scale&&(this.x=this.playground.width/this.playground.scale),this.y<0&&(this.y=0),this.y>1&&(this.y=1),this.damage_speed*=this.friction;else if(this.move_length<this.eps){if(this.move_length=0,this.vx=this.vy=0,"robot"===this.role){let t=Math.random()*this.playground.width/this.playground.scale,i=Math.random()*this.playground.height/this.playground.scale;this.move_to(t,i)}}else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}}render(){let t=this.playground.scale;"robot"!==this.role?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(this.x-this.radius)*t,(this.y-this.radius)*t,2*this.radius*t,2*this.radius*t),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()),"me"===this.role&&"fighting"===this.playground.state&&this.render_skill_coldtime()}render_skill_coldtime(){let t=this.playground.scale,i=1.38,s=.9,e=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.fireball_img,(i-e)*t,(s-e)*t,2*e*t,2*e*t),this.ctx.restore(),this.fireball_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,s*t),this.ctx.arc(i*t,s*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.fireball_coldtime/3)-Math.PI/2,!0),this.ctx.lineTo(i*t,s*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill()),i=1.5,s=.9,e=.04,this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.iceball_img,(i-e)*t,(s-e)*t,2*e*t,2*e*t),this.ctx.restore(),this.iceball_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,s*t),this.ctx.arc(i*t,s*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.iceball_coldtime/3)-Math.PI/2,!0),this.ctx.lineTo(i*t,s*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill()),i=1.62,s=.9,e=.04,this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.flash_img,(i-e)*t,(s-e)*t,2*e*t,2*e*t),this.ctx.restore(),this.flash_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,s*t),this.ctx.arc(i*t,s*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.flash_coldtime/5)-Math.PI/2,!0),this.ctx.lineTo(i*t,s*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}on_destroy(){"me"===this.role&&"fighting"===this.playground.state&&(this.playground.state="over",this.playground.game_over.lose());for(let t=0;t<this.playground.players.length;t++)if(this.playground.players[t]===this){this.playground.players.splice(t,1);break}}destroy_ball(t){for(let i=0;i<this.balls.length;i++){let s=this.balls[i];if(s.uuid===t){s.destroy();break}}}}class Ball extends AcGameObject{constructor(t,i,s,e,a,h,n,l,r,o,d){super(),this.playground=t,this.player=i,this.ctx=this.playground.game_map.ctx,this.x=s,this.y=e,this.radius=a,this.vx=h,this.vy=n,this.color=l,this.speed=r,this.move_length=o,this.damage=d,this.eps=.01}start(){}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.role&&this.update_attack(),this.render()}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];if(this.player!==i&&this.is_collision(i)){this.attack(i);break}}}get_dist(t,i,s,e){let a=t-s,h=i-e;return Math.sqrt(a*a+h*h)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}attack(t){let i=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(i,this.damage),"multi mode"===this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,i,this.damage,this.uuid),this.destroy()}render(){let t=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1);let i=this.color;this.ctx.fillStyle="orange"===i?"rgba(255,97,0,1)":"rgba(217,237,245,1)",this.ctx.fill()}}class MultiPlayerSocket{constructor(t){this.playground=t,this.ws=new WebSocket("wss://www.renyuhui.top/wss/multiplayer/"),this.start()}start(){this.receive()}receive(){let t=this;this.ws.onmessage=function(i){let s=JSON.parse(i.data),e=s.uuid;if(e===t.uuid)return!1;let a=s.event;"create_player"===a?t.receive_create_player(e,s.username,s.photo):"move_to"===a?t.receive_move_to(e,s.tx,s.ty):"shoot_ball"===a?t.receive_shoot_ball(e,s.ball_skill,s.tx,s.ty,s.ball_uuid):"attack"===a?t.receive_attack(e,s.attackee_uuid,s.x,s.y,s.angle,s.damage,s.ball_uuid):"flash"===a?t.receive_flash(e,s.tx,s.ty):"message"===a&&t.receive_message(e,s.username,s.text)}}send_create_player(t,i){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:t,photo:i}))}receive_create_player(t,i,s){let e=new Player(this.playground,this.playground.width/2/this.playground.scale,.5,.06,"white",.15,"enemy",i,s);e.uuid=t,this.playground.players.push(e)}send_move_to(t,i){this.ws.send(JSON.stringify({event:"move_to",uuid:this.uuid,tx:t,ty:i}))}receive_move_to(t,i,s){let e=this.get_player(t);e&&e.move_to(i,s)}get_player(t){let i=this.playground.players;for(let s=0;s<i.length;s++){let e=i[s];if(e.uuid===t)return e}return null}send_shoot_ball(t,i,s,e){this.ws.send(JSON.stringify({event:"shoot_ball",uuid:this.uuid,ball_skill:t,tx:i,ty:s,ball_uuid:e}))}receive_shoot_ball(t,i,s,e,a){let h=this.get_player(t);if(h){h.shoot_ball(i,s,e).uuid=a}}send_attack(t,i,s,e,a,h){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:t,x:i,y:s,angle:e,damage:a,ball_uuid:h}))}receive_attack(t,i,s,e,a,h,n){let l=this.get_player(t),r=this.get_player(i);l&&r&&r.receive_attack(s,e,a,h,n,l)}send_flash(t,i){this.ws.send(JSON.stringify({event:"flash",uuid:this.uuid,tx:t,ty:i}))}receive_flash(t,i,s){let e=this.get_player(t);e&&e.flash(i,s)}send_message(t,i){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,username:t,text:i}))}receive_message(t,i,s){this.playground.chat_field.add_message(i,s)}}class Star extends AcGameObject{constructor(t,i,s){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s}start(){}update(){this.ctx.beginPath(),this.ctx.arc(this.x,this.y,.001*this.playground.height,0,2*Math.PI,!1),this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fill()}}class AcGamePlayground{constructor(t){this.root=t,this.$playground=$('<div class="ac-game-playground"></div>'),this.hide(),this.root.$ac_game.append(this.$playground),this.start()}get_random_color(){return["blue","red","orange","green","yellow","purple","brown"][Math.floor(7*Math.random())]}create_uuid(){let t="";for(let i=0;i<8;i++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){let t=this,i=this.create_uuid();$(window).on(`resize.${i}`,(function(){t.resize()})),this.root.AcWingOS&&this.root.AcWingOS.api.window.on_close((function(){$(window).off(`resize.${i}`)}))}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let t=Math.min(this.width/16,this.height/9);this.width=16*t,this.height=9*t,this.scale=this.height,this.game_map&&this.game_map.resize()}show(t){let i=this;if(this.$playground.show(),this.width=this.$playground.width(),this.height=this.$playground.height(),this.game_map=new GameMap(this),this.mode=t,this.state="waiting",this.notice_board=new NoticeBoard(this),this.player_count=0,this.resize(),this.players=[],this.players.push(new Player(this,this.width/2/this.scale,.5,.06,"white",.15,"me",this.root.settings.username,this.root.settings.photo)),"single mode"===t){for(let t=0;t<8;t++)this.players.push(new Player(this,this.width*Math.random()/this.scale,Math.random(),.06,this.get_random_color(),.15,"robot"));this.game_over=new GameOver(this,"single mode")}else"multi mode"===t&&(this.chat_field=new ChatField(this),this.game_over=new GameOver(this,"multi mode"),this.mps=new MultiPlayerSocket(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=function(){i.mps.send_create_player(i.root.settings.username,i.root.settings.photo)})}hide(){for(;this.players&&this.players.length>0;)for(let t=0;t<this.players.length;t++){let i=this.players[t];if(i.balls&&i.balls.length>0)for(let t=0;t<i.balls.length;t++)i.balls[t].destroy();i.destroy()}this.game_map&&(this.game_map.destroy(),this.game_map=null),this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.game_over&&(this.game_over.destroy(),this.game_over=null),this.$playground.empty(),this.$playground.hide()}}class Settings{constructor(t){"app5372.acapp.acwing.com.cn"===window.location.host&&window.location.replace("https://www.renyuhui.top/"),this.root=t,this.platform="WEB",this.root.AcWingOS&&(this.platform="ACAPP"),this.username="",this.photo="",this.$settings=$('\n<div class="ac-game-settings">\n    <div class="ac-game-settings-login">\n        <div class="ac-game-settings-title">\n            登录\n        </div>\n        <div class="ac-game-settings-username">\n            <div class="ac-game-settings-item">\n                <inpUT TYpe="text" placeholder="用户名">\n            </div>\n        </div>\n        <div class="ac-game-settings-password">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-submit">\n            <div class="ac-game-settings-item">\n                <button>登录</button>\n            </div>\n        </div>\n        <div class="ac-game-settings-error-message">\n        </div>\n        <div class="ac-game-settings-option">\n            注册\n        </div>\n        <br>\n        <div class="ac-game-settings-third-party-logins">\n            <div class="image-wrapper">\n                <img width="40" src="https://www.renyuhui.top/static/image/settings/acwing_logo.png" class="acwing-logo">\n                <img width="40" src="https://www.renyuhui.top/static/image/settings/qq_logo.png" class="qq-logo">\n            </div>\n            <div class="text-wrapper">\n                <div>第三方一键登录</div>\n            </div>\n        </div>\n    </div>\n    <div class="ac-game-settings-register">\n        <div class="ac-game-settings-title">\n            注册\n        </div>\n        <div class="ac-game-settings-username">\n            <div class="ac-game-settings-item">\n                <input type="text" placeholder="用户名">\n            </div>\n        </div>\n        <div class="ac-game-settings-password ac-game-settings-password-first">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-password ac-game-settings-password-second">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="确认密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-submit">\n            <div class="ac-game-settings-item">\n                <button>注册</button>\n            </div>\n        </div>\n        <div class="ac-game-settings-error-message">\n        </div>\n        <div class="ac-game-settings-option">\n            登录\n        </div>\n        <br>\n        <div class="ac-game-settings-third-party-logins">\n            <div class="image-wrapper">\n                <img width="30" src="https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png" class="acwing-logo">\n                <img width="30" src="https://www.renyuhui.top/static/image/settings/qq_logo.png" class="qq-logo">\n            </div>\n            <div class="text-wrapper">\n                <div>第三方一键登录</div>\n            </div>\n        </div>\n    </div>\n\n</div>\n'),this.$login=this.$settings.find(".ac-game-settings-login"),this.$login_username=this.$login.find(".ac-game-settings-username input"),this.$login_password=this.$login.find(".ac-game-settings-password input"),this.$login_submit=this.$login.find(".ac-game-settings-submit button"),this.$login_error_message=this.$login.find(".ac-game-settings-error-message"),this.$login_register=this.$login.find(".ac-game-settings-option"),this.$login.hide(),this.$register=this.$settings.find(".ac-game-settings-register"),this.$register_username=this.$register.find(".ac-game-settings-username input"),this.$register_password=this.$register.find(".ac-game-settings-password-first input"),this.$register_password_confirm=this.$register.find(".ac-game-settings-password-second input"),this.$register_submit=this.$register.find(".ac-game-settings-submit button"),this.$register_error_message=this.$register.find(".ac-game-settings-error-message"),this.$register_login=this.$register.find(".ac-game-settings-option"),this.$register.hide(),this.$acwing_login=this.$settings.find(".ac-game-settings-third-party-logins .image-wrapper .acwing-logo"),this.$qq_login=this.$settings.find(".ac-game-settings-third-party-logins .image-wrapper .qq-logo"),this.root.$ac_game.append(this.$settings),this.start()}start(){"ACAPP"===this.platform?this.getinfo_acapp():(this.getinfo_web(),this.add_listening_events())}add_listening_events(){let t=this;this.add_listening_events_login(),this.add_listening_events_register(),this.$acwing_login.click((function(){t.acwing_login()})),this.$qq_login.click((function(){t.qq_login()}))}add_listening_events_login(){let t=this;this.$login_register.click((function(){t.register()})),this.$login_submit.click((function(){t.login_on_remote()}))}add_listening_events_register(){let t=this;this.$register_login.click((function(){t.login()})),this.$register_submit.click((function(){t.register_on_remote()}))}acwing_login(){$.ajax({url:"https://www.renyuhui.top/settings/acwing/web/apply_code/",type:"GET",success:function(t){"success"===t.result&&window.location.replace(t.apply_code_url)}})}qq_login(){$.ajax({url:"https://www.renyuhui.top/settings/qq/apply_code/",type:"GET",success:function(t){"success"===t.result&&window.location.replace(t.apply_code_url)}})}login_on_remote(){let t=this,i=this.$login_username.val(),s=this.$login_password.val();this.$login_error_message.empty(),$.ajax({url:"https://www.renyuhui.top/settings/login/",type:"GET",data:{username:i,password:s},success:function(i){"success"===i.result?location.reload():t.$login_error_message.html(i.result)}})}logout_on_remote(){"ACAPP"===this.platform?this.root.AcWingOS.api.window.close():$.ajax({url:"https://www.renyuhui.top/settings/logout/",success:function(t){"success"===t.result&&location.reload()}})}register_on_remote(){let t=this,i=this.$register_username.val(),s=this.$register_password.val(),e=this.$register_password_confirm.val();$.ajax({url:"https://www.renyuhui.top/settings/register/",type:"GET",data:{username:i,password:s,password_confirm:e},success:function(i){"success"===i.result?location.reload():t.$register_error_message.html(i.result)}})}register(){this.$login.hide(),this.$register.show()}login(){this.$register.hide(),this.$login.show()}acapp_login(t,i,s,e){let a=this;a.root.AcWingOS.api.oauth2.authorize(t,i,s,e,(function(t){"success"===t.result&&(a.username=t.username,a.photo=t.photo,a.hide(),a.root.menu.show())}))}getinfo_acapp(){let t=this;$.ajax({url:"https://www.renyuhui.top/settings/acwing/acapp/apply_code/",type:"GET",success:function(i){"success"===i.result&&t.acapp_login(i.appid,i.redirect_uri,i.scope,i.state)}})}getinfo_web(){let t=this;$.ajax({url:"https://www.renyuhui.top/settings/getinfo/",type:"GET",data:{platform:t.platform},success:function(i){t.username=i.username,t.photo=i.photo,"success"===i.result?(t.hide(),t.root.menu.show()):t.login()}})}hide(){this.$settings.hide()}show(){this.$settings.show()}}export class AcGame{constructor(t,i){this.id=t,this.$ac_game=$("#"+t),this.AcWingOS=i,this.settings=new Settings(this),this.introduce=new AcGameIntroduce(this),this.menu=new AcGameMenu(this),this.playground=new AcGamePlayground(this)}}
